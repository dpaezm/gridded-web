<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gridded.Agency</title>
    <link rel="icon" href="/favicon.png?v=1" type="image/png" />

    <!-- Google Analytics (Consent Mode bloqueado por defecto) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JD720QFSJ8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("consent", "default", {
        ad_storage: "denied",
        analytics_storage: "denied",
      });
      gtag("js", new Date());
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>

    <!-- CookieYes script (al final del body) -->
    <script
      id="cookieyes"
      type="text/javascript"
      src="https://cdn-cookieyes.com/client_data/1dd7962301f49134dd26a86f/script.js"
    ></script>

    <!-- Consentimiento GA dinámico con CookieYes (polling de cookie) -->
    <script>
      // Devuelve el valor de una cookie por nombre
      function getCookie(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return match ? decodeURIComponent(match[2]) : null;
      }

      let lastConsent = null;
      setInterval(() => {
        const consentCookie = getCookie('cookieyes-consent');
        if (consentCookie && consentCookie !== lastConsent) {
          lastConsent = consentCookie;
          // Intenta parsear el consentimiento (puede ser JSON o CSV)
          let analyticsConsent = false;
          try {
            // CookieYes v4: JSON, v3: CSV
            if (consentCookie.startsWith('{')) {
              const consentObj = JSON.parse(consentCookie);
              analyticsConsent = consentObj.analytics === 'yes';
            } else {
              // CSV: e.g. "necessary:yes,analytics:yes,advertisement:no"
              analyticsConsent = /analytics:(yes|true)/.test(consentCookie);
            }
          } catch (e) {
            // fallback: busca analytics:yes
            analyticsConsent = /analytics:(yes|true)/.test(consentCookie);
          }

          gtag('consent', 'update', {
            analytics_storage: analyticsConsent ? 'granted' : 'denied',
            ad_storage: 'denied'
          });
          if (analyticsConsent) {
            gtag('config', 'G-JD720QFSJ8');
            console.log('✅ GA activado tras consentimiento (cookie polling)');
          } else {
            console.log('❌ GA bloqueado tras consentimiento (cookie polling)');
          }
        }
      }, 500);
    </script>
  </body>
</html>
